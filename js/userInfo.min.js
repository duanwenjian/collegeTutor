var files;$(".j-updateUser").click(function(){document.getElementById("updateFile").click()});$("#updateFile").change(function(){$("#cut-img").modal("show")});$("#clipBtn").click(function(){$("#updateImageFiles").show()});$("body").on("click","#updateImageFiles",function(){$.ajax({url:"php/base64ImgSave.php",type:"POST",dataType:"json",data:{imageFile:files,userID:localStorage.getItem("userID")},success:function(data){if(+data.retCode==0){$("#cut-img").modal("hide");localStorage.setItem("Headportrait",data.retMsg);$(".j-userImg").attr("src",data.retMsg);$(".navbar-user-avatar").attr("src",data.retMsg)}},error:function(){}})});$("#clipArea").photoClip({width:200,height:200,file:"#updateFile",view:"#view",ok:"#clipBtn",loadStart:function(){console.log("照片读取中")},loadComplete:function(){console.log("照片读取完成")},clipFinish:function(dataURL){files=dataURL}});function getWeekMonth(){var data=new Array(6);var time=new Date;var M=time.getMonth()+1;var D=time.getDay();var day=time.getDate();var lasDay=getFirstAndLastMonthDay(1);var nextlasday=getFirstAndLastMonthDay(0);if(D==1){for(var i=0;i<7;i++){if(day+i>lasDay){data[i]=M+1+"-"+(day+i-lasDay)}else{data[i]=M+"-"+(day+i)}}return data}if(D==0){for(var i=7;i>0;i--){if(day-i<0){data[i-1]=M-1+"-"+(day-i)}else{data[i-1]=M+"-"+(day-i)}}data.reverse();return data}if(D>0&&D<6){var data=new Array(D);for(var i=0;i<D;i++){if(day-i<=0){data[i]=M-1+"-"+(nextlasday-i+day)}else{data[i]=M+"-"+(day-i)}}for(var j=1;j<=7-D;j++){if(lasDay<day+j){data.unshift(M+1+"-"+(day+j-lasDay))}else{data.unshift(M+"-"+(day+j))}}data.reverse();return data}}function getFirstAndLastMonthDay(n){var day=new Date((new Date).getFullYear(),(new Date).getMonth()+n,0);var lastdate=day.getDate();return lastdate}$(document).ready(function(){getUserInfoDate();$(".j-userImg").attr("src",localStorage.getItem("Headportrait"));$(".j-username").html(localStorage.getItem("username"))});var userInfo={};function getUserInfoDate(){$.ajax({url:"php/getUserInfo.php",type:"GET",data:{userID:localStorage.getItem("userID")},dataType:"json",success:function(data){if(data.retCode==0){userInfo.dealInfo=data.dealInfo;echer1(userInfo.dealInfo);echer2(userInfo.dealInfo);echer3(data.teacherFeedBack)}},error:function(){}})}var getDeal1={data:null,weekDay:null,weekArr:null,series:[],minTime:null,maxTime:null,titleArr:[],ProgressArr:[],talkList:null,talkPie:null,init:function(data){this.data=data;this.weekDay=getWeekMonth()},dealTitle:function(data){this.init(data);this.titleArr=[];for(var i=0;i<this.data.length;i++){this.titleArr.push(this.data[i].username)}return this.titleArr},dealList:function(data){this.init(data);var y=(new Date).getFullYear();this.maxTime=new Date(y+"-"+getWeekMonth()[6]+" 08:00:00").getTime();this.minTime=new Date(y+"-"+getWeekMonth()[0]+" 08:00:00").getTime();for(var i=0;i<this.data.length;i++){this.weekArr=[,,,,,,,];if(+this.data[i].startTime<this.minTime){var length;if(+this.data[i].endTime>=this.maxTime){length=this.weekArr.length}else{length=7-this.getTimeDay(parseInt(this.data[i].endTime),this.maxTime)}for(var j=0;j<length;j++){if(this.getUserWeekDay(this.data[i].week,y+"-"+getWeekMonth()[j]+" 08:00:00")!=-1){this.weekArr[j]=parseInt(this.data[i].price)}}}if(+this.data[i].startTime>this.minTime){var days="",length;days=this.getTimeDay(this.minTime,this.data[i].startTime);if(+this.data[i].endTime>=this.maxTime){length=this.weekArr.length}else{length=7-this.getTimeDay(parseInt(this.data[i].endTime),this.maxTime)}for(var j=days;j<=length;j++){if(this.getUserWeekDay(this.data[i].week,y+"-"+getWeekMonth()[j]+" 08:00:00")!=-1){this.weekArr[j]=parseInt(this.data[i].price)}}}var obj={name:getDeal1.data[i].username,type:"line",step:"start",data:getDeal1.weekArr};this.series.push(obj)}return this.series},getTimeDay:function(startDate,endDate){var dates=Math.abs(parseInt(endDate)-parseInt(startDate))/(1e3*60*60*24);return dates},getUserWeekDay:function(str,s){return str.indexOf("日一二三四五六".split("")[new Date(s).getDay()])},dealProgress:function(data){this.data=data;var data1=[],data2=[];for(var i=0;i<this.data.length;i++){var time=new Date;var nowDate=new Date(time.getFullYear()+"-"+(time.getMonth()+1)+"-"+time.getDate()+" 08:00:00").getTime();var lengthDay=this.getTimeDay(this.data[i].startTime,this.data[i].endTime);var nowDay=this.getTimeDay(this.data[i].startTime,nowDate);data1.push(nowDay);data2.push(lengthDay)}var obj1={type:"bar",barWidth:"30%",z:10,data:data1,coordinateSystem:"polar",name:"现阶段完成时间"};this.ProgressArr.push(obj1);var obj2={type:"bar",itemStyle:{normal:{color:"#ddd"}},silent:true,barWidth:"30%",barGap:"-100%",data:data2,coordinateSystem:"polar",name:"总时间"};this.ProgressArr.push(obj2);return this.ProgressArr},getTalk:function(d){this.talkList=d;this.talkPie=[{value:0},{value:0},{value:0},{value:0},{value:0}];for(var i=0;i<this.talkList.length;i++){this.talkPie[parseInt(this.talkList[i].talkGrade)-1].value++}return this.talkPie}};function echer1(d){var myChart=echarts.init(document.getElementById("teacherTime"),"wonderland");var data=getWeekMonth();option1={title:{text:"授课日程安排",left:"center",show:false},tooltip:{trigger:"axis"},legend:{show:false},grid:{left:"8%",right:"4%",bottom:"3%",containLabel:true},toolbox:{feature:{saveAsImage:{}}},xAxis:{type:"category",data:data,name:"上课时间",nameLocation:"start"},yAxis:{type:"value",name:"价格",nameLocation:"end"},series:getDeal1.dealList(d),legend:{data:getDeal1.dealTitle(d)}};myChart.setOption(option1)}function echer2(d){var dealInfo=echarts.init(document.getElementById("dealInfo"),"wonderland");option2={title:{text:"",left:"center",show:false},tooltip:{trigger:"axis"},toolbox:{feature:{saveAsImage:{}}},angleAxis:{show:false},radiusAxis:{type:"category",data:getDeal1.dealTitle(d),z:10},polar:{},series:getDeal1.dealProgress(d),legend:{show:true,data:["交易完成情况"]}};dealInfo.setOption(option2)}function echer3(d){var teacherfeed=echarts.init(document.getElementById("teacherfeed"),"wonderland");var data=getDeal1.getTalk(d);option3={title:{text:"评价表",x:"center"},tooltip:{trigger:"item",formatter:"{a} <br/>{b} : {c} ({d}%)"},legend:{x:"center",y:"bottom",data:["1星","2星","3星","4星","5星"]},toolbox:{show:true,feature:{mark:{show:true},dataView:{show:true,readOnly:false},magicType:{show:true,type:["pie","funnel"]},restore:{show:true},saveAsImage:{show:true}}},calculable:true,series:[{name:"所占全部评论比例",type:"pie",radius:[30,110],center:["50%","50%"],roseType:"area",data:[{value:data[0].value,name:"1星"},{value:data[1].value,name:"2星"},{value:data[2].value,name:"3星"},{value:data[3].value,name:"4星"},{value:data[4].value,name:"5星"}]}]};teacherfeed.setOption(option3)}